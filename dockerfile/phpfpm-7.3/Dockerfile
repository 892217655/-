FROM php:7.3-fpm
MAINTAINER lightbrother 892217655@qq.com

# 下载源切换成阿里源
RUN set -eux; \
    sed -i 's/deb\.debian\.org/mirrors\.aliyun\.com/g' /etc/apt/sources.list; \
    sed -i 's/security\.debian\.org/mirrors\.aliyun\.com/g' /etc/apt/sources.list; \

# 安装composer
    php -r "copy('https://install.phpcomposer.com/installer', 'composer-setup.php');"; \
    php composer-setup.php; \
    mv composer.phar /usr/local/bin/composer; \
    composer selfupdate; \
    composer config -g repos.packagist composer https://php.cnpkg.org; \

# 安装扩展所需要的第三方库
    apt-get update; \
    apt-get install -y --no-install-recommends \
        librdkafka-dev \
        libzip-dev \
        vim \
        libpng-dev \
        libjpeg-dev \
        libxft-dev \
        libbz2-dev \
        libssl-dev \
    ; \
	rm -rf /var/lib/apt/lists/*; \

# 选择php.ini
    cd /usr/local/etc/php; \
    mv php.ini-production php.ini; \

# 安装php扩展 --redis和kafka扩展以及自带扩展
    pecl install redis; \
    pecl install rdkafka; \
    sed  -i '$aextension=redis\.so' /usr/local/etc/php/php.ini; \
    sed  -i '$aextension=rdkafka\.so' /usr/local/etc/php/php.ini
    
# gd库需要自已编译
# ./configure --with-php-config=php-config --with-jpeg-dir=/usr/lib/x86_64-linux-gnu/libjpeg --with-png-dir=/usr/lib/x86_64-linux-gnu/libpng --with-freetype-dir=/usr/lib/x86_64-linux-gnu/libxft

# 其他扩展使用docker-php-ext-install 即可

# 启动fpm
ENTRYPOINT ["docker-php-entrypoint"]
##<autogenerated>##
WORKDIR /var/www/html

EXPOSE 9000
CMD ["php-fpm"]